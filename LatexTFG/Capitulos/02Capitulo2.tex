%---------------------------------------------------------------------
%
%                          Capítulo 2
%
%---------------------------------------------------------------------

\chapter{Antecedentes}

\begin{FraseCelebre}
\begin{Frase}
Cada día sabemos más \\
y entendemos menos. 
\end{Frase}
\begin{Fuente}
Albert Einstein
\end{Fuente}
\
\end{FraseCelebre}

\begin{resumen}
Para la realización del presente proyecto ha sido necesario realizar una investigación que cubre desde aspectos médicos hasta aspectos técnicos propios de una ingeniería compleja. En este capítulo se expone un breve resumen de cada antecedente investigado.
\end{resumen}


%-------------------------------------------------------------------
\section{Electrocardiograma}
%-------------------------------------------------------------------
\label{cap2:sec:electro}

Un electrocardiograma (más popularmente conocido como ECG) es un proceso por el cual se registran las actividades eléctricas que emite el corazón durante un tiempo determinado.

El registro de esta actividad cardiaca es posible gracias a las diferencias de potencial existentes producidas por la contractilidad del corazón. El estudio de la información ilustrada por un ECG puede ser de gran utilidad a la hora de detectar multitud de enfermedades cardiovasculares, así como prevenir problemas cardiacos de forma precoz.

La ventaja de un ECG frente a otros métodos de medición para comprobar el estado del corazón, es que el ECG aporta mucha más información que los métodos más habituales como pueden ser simplemente medir el pulso o utilizar un estetoscopio.

Entre la información extra que puede obtenerse recurriendo al ECG, cabe destacar desde la medición continua durante un tiempo prolongado (días incluso si se utiliza un ECG portátil) hasta la obtención del movimiento de los músculos del corazón (los electrodos conectados al paciente registran esos movimientos en \textit{mV}), lo cual permite saber cuando entra la sangre, cuando sale, cuanto dura cada movimiento, etc. Sin esa información sería imposible detectar ciertos tipos de arritmias y/o otras alteraciones del corazón.

%-------------------------------------------------------------------
\subsection{Estructura de un ECG}
%-------------------------------------------------------------------
\label{cap2:subsec:estructura}

La estructura habitual de un ECG [Fig \ref{fig:ondaecg}] habitualmente está formada por un conjunto de ondas y complejos determinados:

\begin{itemize}  
\item Onda P 
\item Onda Q 
\item Complejo QRS
\item Onda T
\item Onda U
\end{itemize}

\figura{Vectorial/ecg}{width=.7\textwidth}{fig:ondaecg}%
{Estructura habitual de la señal ECG durante un ciclo cardiaco.}

Habitualmente este tipo de señales se encuentran dentro de un rango determinado de amplitudes, que generalmente abarca desde los 0.5\textit{mV} hasta los 5\textit{mV}, existiendo además una componente continua causada por el contacto existente entre los electrodos y la piel. 

Mayormente este tipo de señales suele ilustrarse en los libros de forma muy clara y reconocible, aunque no siempre es posible disponer de un entorno con las características propicias para eliminar toda existencia de ruido en la señal. Generalmente el ruido que se recoge al analizar este tipo de señales es despreciado, aunque en ciertas ocasiones puede llegar a ser tan difuso, que nos impida reconocer hasta las pautas más características de una señal ECG.

Puede presentarse ruido en la señal simplemente debido a la luz tanto natural como artificial que incida indirectamente en los electrodos, así como debido a la corriente que reciben los dispositivos que nos permiten llevar a cabo la medición de la señal.


%-------------------------------------------------------------------
\subsection{Funcionamiento interno del corazón}
%-------------------------------------------------------------------
\label{cap2:subsec:func}

\figura{Vectorial/corazon}{width=.7\textwidth}{fig:corazon}%
{Estructura anatómica del corazón humano}

El corazón está constituido por cuatro cámaras diferenciadas: dos aurículas (izquierda y derecha) y dos ventrículos (izquierdo y derecho) como puede apreciarse en la [Fig \ref{fig:corazon}]


Su funcionamiento sigue siempre un mismo ciclo que se repite una y otra vez: la aurícula derecha recibe la sangre venosa del cuerpo a través de la vena cava superior y la envía al ventrículo derecho. Para que dicha sangre pueda oxigenarse, el ventrículo derecho la envía a través de la arteria pulmonar a los pulmones, retornando al corazón, a través de la vena pulmonar, a la aurícula izquierda. Para finalizar con el ciclo, la sangre pasa de dicha aurícula al ventrículo izquierdo, el cual la distribuye por todo el cuerpo gracias a la arteria aorta, para volver posteriormente a la aurícula derecha y así cerrar el ciclo.

Para que este ciclo periódico funcione de manera correcta, síncrona y con total ausencia de errores, el corazón dispone de un sistema de conducción eléctrica constituido por fibras de músculo cardiaco cuya finaludad es la transmisión de impulsos eléctricos. El motivo por el cual no tenemos ningún tipo de control sobre los latidos del corazón es porque este sistema es autoexcitable.

%-------------------------------------------------------------------
\subsection{Obtención del ECG}
%-------------------------------------------------------------------
\label{cap2:subsec:obtención}

El proceso físico a traves del cual se realiza el procedimiento de registro y se obtiene el ECG consiste en la medición de la actividad eléctrica del corazón entre distintos puntos corporales, ya que, mientras que el corazón pasa por los estados de polarización y despolarización, el cuerpo en su conjunto se comporta como un volumen conductor, propagando la corriente eléctrica.

El equipo de registro consta de una serie de electrodos, que se conectan a la piel del paciente y a un equipo de registro. Estos electrodos se colocan en unas posiciones predeterminadas y universales, lo que permite obtener el registro del sistema de la forma más precisa y exacta posible.


%-------------------------------------------------------------------
\subsection{Utilidades del ECG}
%-------------------------------------------------------------------
\label{cap2:subsec:utilidades}

Tras la obtención de un ECG completo, se tendrá un registro completo acerca del tamaño, la cadencia, y la naturaleza de los impulsos eléctricos emitidos por el corazón. Gracias a esta información, es posible definir tanto el ritmo como la frecuencia cardiaca. Este tipo de información puede ser crucial a la hora de detectar ciertos problemas cardiacos. A continuación se detallan posibles utilidades que puede tener la obtención de un ECG:

\begin{itemize}
  \item Obtener información sobre el estado físico del corazón.
  \item Detectar problemas cardiacos de forma precoz, o alteraciones elecctróliticas de potasio, sodio, calcio, magnesio, u otros elementos químicos.
   \item Determinar si el corazón funciona correctamente, en caso de no encontrar ninguna anomalía.
   \item Adquirir información acerca de la repercusión miocárdica de diversas enfermedades cardiacas.
    \item Detección de anormalidades conductivas.
    \item Indicar bloqueos coronarios arteriales.
\end{itemize}

%-------------------------------------------------------------------
\section{Tecnologías}
%-------------------------------------------------------------------
\label{cap2:sec:tecnologias}

\figura{Vectorial/bbb}{width=.9\textwidth}{fig:bbb}%
{Vista general de una BeagleBone Black}

Para llevar a cabo el correcto desarrollo del trabajo que se expone en la presente memoria, ha sido necesaria la investigación y el desarrollo de diversas tecnologías que se expondrán a continuación, así como el estudio y la asimilación de tecnologías ya existentes con el fin de adaptarlas y modificarlas para el proyecto desarrollado.

Como módulo de procesamiento se ha utilizado una placa BeagleBone Black (puede apreciarse una visión general de esta placa en la [Fig \ref{fig:bbb}]), aprovechando la gran comunidad de desarrolladores existentes gracias a la cual fue posible resolver los problemas que fueron surgiendo durante el desarrollo, y aprovechando también el bajo costo de la placa así como la multitud de posibilidades que ofrece. En cuanto al tratamiento y captura de señales se ha utilizado el chip ADS1198 de Texas Intruments, que permite unas velocidades de captura suficientemente elevadas para este tipo de desarrollos además de tener un coste asequible. Con motivos de depuración durante el tratamiento de las distintas señales que se han obtenida, se ha utilizado Saleae Logic, un analizador lógico USB que cuenta con 8 canales para cada posible señal. Como método de sincronización entre los dispositivos que lo necesitasen se ha recurrido a una interfaz SPI.

%-------------------------------------------------------------------
\subsection{BeagleBone Black}
%-------------------------------------------------------------------
\label{cap2:subsec:bbb}

La BeagleBone es una plataforma compacta, de bajo coste y operada por software libre Linux que puede ser usada para complejas aplicaciones en las que intervenga software de alto nivel y circuitos electrónicos de bajo nivel \citep{exploringBBB}. Nostros concretamente nos hemos decantado por trabajar con la última versión de la plataforma BeagleBone, es decir, BeagleBone Black (BBB), ya que era la placa que más flexibilidad aportaba al presente proyecto. Las características de la BBB son las siguientes:
\begin{itemize}
  \item Es muy potente, ya que contiene un procesador que puede realizar hasta 2 billones de instrucciones por segundo (2000 MIPS).
  \item Tiene un coste bastante asequible, ya que su precio oscila entre los 45\$ y los 55\$.
  \item Es compatible con muchos estandares de interfaces para dispotivos electronicos (SPI entre otros).
  \item Es muy eficiente, ya que requiere únicamente entre 1 y 2.3 W, según este inactivo, o funcionando a máxima potencia.
  \item Es fácilmente ampliable a través de otro tipo de placas de expansión opcionales y de dispositivos USB.
  \item Tiene una gran comunidad de desarrolladores innovadores y entusiastas que respaldan y dan soporte a los usuarios de la plataforma.
  \item Es hardware libre, y es compatible con multitud de herramientas y de aplicaciones de software libre.
\end{itemize}

La plataforma BeagleBone lleva el sistema operativo Linux, lo que significa que es posible usar todo tipo de librerías de software libre, y aplicaciones. La posibilidad de usar software libre, brinda también la oportunidad de conectar esta plataforma con todo tipo de perifericos como pueden ser cámaras USB, teclados, adaptadores Wi-Fi \ldots

%-------------------------------------------------------------------
\subsubsection{Versiones BeagleBoneBlack}
%-------------------------------------------------------------------
\label{cap2:subsec:versiones}

La plataforma BeagleBone y sus placas computadoras han evolucionado progresivamente con el paso de lo años, tanto en prestaciones, como en reducción del coste final. A continuación se muestra el progreso de la plataforma en orden histórico.

\begin{itemize}
  \item \textbf{(2008) BeagleBoard (125\$)} La original placa de desarrollo de hardware libre basada en ARM que tiene soporte para video HD. Tiene un Procesador ARM A8 a 720MHz pero no tiene conexión Ethernet.
  \item \textbf{(2010) BeagleBoard xM (149\$)} Similar a la BeagleBoard, solo que tiene un procesador ARM AM37x a 1Ghz, 512MB de memoria, cuatro puertos USB, y soporte para Ethernet. Es una placa muy popular por su núcleo C64+TMDSP para procesamiento de señales digitales.
  \item \textbf{(2011) BeagleBone (89\$)} Más compacta que su antecesora la BeagleBoard. Tiene un procesador a 720Mhz y 256MB de memoria, soporta Ethernet y conexiones de salida de bajo nivel, pero no tiene soporte nativo de video.
  \item \textbf{(2013) BeagleBone Black (45\$-55\$)} Esta placa mejora la BeagleBone con un procesador a 1GHz, 512MB de memoria DDR3, conexión Ethernet, almacenamietno eMMC y soporte para conexión de video HDMI.
\end{itemize}

\figura{Vectorial/Features}{width=1\textwidth}{fig:feat}
{Especificación hardware BeagleBone Black}

La especificación completa de las carácteristicas de la BBB se muestran con más detalle en la [Fig. \ref{fig:feat}] \citep{BBBsite}


%-------------------------------------------------------------------
\subsection{Bus SPI}
%-------------------------------------------------------------------
\label{cap2:subsec:bus}

El bus SPI (del inglés Serial Pripheral Interface) es un estándar de comunicación síncrono, rápido y bidireccional que permite comunicar dispositivos como la BBB con otros dipositivos en una distancia corta \citep{exploringBBB}. Es posible que la comunicación sea bidireccional, ya que tanto la transmisión como la recepción de datos se realizan en buses separados. 

En la transferencia de datos se implican distintos dispositivos que desempeñan diferentes funciones. Existe un dispositivo principal, más conocido como maestro, y otro  dispositivo denominado esclavo (como mínimo debe existir uno). El maestro es responsable de enviar las señales de reloj y de seleccionar  al esclavo activo en cada instante de la comunicación. 

\figura{Vectorial/spi}{width=0.7\textwidth}{fig:spi}
{Estándar de comunicación SPI}

Las diferentes líneas existentes en este estándar de comunicación son las siguientes [Fig \ref{fig:spi}]:

\begin{itemize}
  \item \textbf{MISO} (Master Input Slave Output): Bus de salida de datos de los dispositivos esclavos y de entrada al maestro.
  \item \textbf{MOSI} (Master Output Slave Input): Bus de salida de datos del maestro y entrada a los esclavos.
   \item \textbf{SCK} (Clock o señal de reloj): Pulso de reloj generado por el maestro.
   \item \textbf{SS/Select} (Chip Select): Bus de salida del maestro y entrada a los esclavos, encargado de seleccionar el dispositivo esclavo activo en la comunicación.
\end{itemize}

Con el fin de procesar una lectura desde un dispositivo esclavo, el maestro debe realizar una escritura en el bus, forzando de esta forma la generación de una señal del reloj que tendrá como consecuencia la escritura de datos por parte del dispositivo deseado.

El dispositivo maestro debe conocer las características de cada esclavo implicado en la comunación, entre las cuales, es posible destacar las siguientes:

\begin{itemize}
  \item \textbf{Frecuencia máxima de transferencia}: La velocidad de comunicación  con cada dispositivo etará limitada por este valor, haciendo imposible enviar o recibir datos a mayor velocidad.
   \item \textbf{Polaridad} (CPOL): Determina la polaridad del reloj [Fig \ref{fig:spi3}].
   \item \textbf{Fase} (CPHA): Determina el flanco de reloj en el que se desencadenará la escritura [Fig \ref{fig:spi3}].
\end{itemize}

\figura{Vectorial/spi3}{width=1\textwidth}{fig:spi3}
{Configuraciónes posibles de fase y polaridad en el estándar SPI}

%-------------------------------------------------------------------
\subsection{Chip ADS1198}
%-------------------------------------------------------------------
\label{cap2:subsec:ads}

El ADS1198 es un chip de Texas Instruments de bajo consumo para mediciones de señales ECG, que se caracteriza por tener ocho canales de 16 bits cada uno, una frecuencia de muestreo de hasta 8KHz, un amplificados de ganancia programable, referencia interna, y un oscilador integrado. \citep{ads1198} Cada canal consta de un multiplexor que permite la lectura desde ocho entradas diferentes, siendo las más relevantes las entradas de temperatura, electrodos, y señal de test generada internamente.

El chip consta de una interfaz SPI para permitir la comunicación con otros sipositivos. Además de las líneas típicas de SPI se proporciona una línea adicional, \textbf{DRDY} (Data ready), que índica cuando se tienen nuevos datos válidos preparados para enviar. La lectura de datos se realiza siempre para los 8 canales, devolviendo adicionalmente una cabecera con información de la configuración del chip.

El chip permite obtener la alimentación de manera unipolar o bipolar:

\begin{itemize}
  \item \textbf{Unipolar}: La alimentación unipolar se realiza mediante una entrada de 5V y otra de 3V.
   \item \textbf{Bipolar}: El modo bipolar requiere entradas desde -2.5V hasta 2.5V.
\end{itemize}

La alimentación que se ha utilizado en este proyecto ha sido unipolar, por ser más facilmente adaptable a los pines que proporciona la BBB.

Internamente el ADS1198 cuenta con 25 registros que permiten al usuario configurar todas las características programables del chip [Fig \ref{fig:ads}]. Gran parte de la configuración permitida está relacionada con aspectos propios de la captura de señales, como las ganancias, el uso de un oscilador interno, o el voltaje de referencia utilizado para la captura. El resto de configuraciones posibles pueden variar la frecuencia de captura, las entradas de los canales o modificar las señales de test internas en amplitud y frecuencia.

Para el propósito del presente proyecto, se ha utilizado un kit de desarrollo, en el que se incluye el chip integrado en una placa que permite configurar la forma de alimentación o tener acceso a las entradas de datos de forma más cómoda y sencilla.

\figura{Vectorial/ads}{width=1\textwidth}{fig:ads}
{Diagrama de funcionamiento interno ADS1198}

%-------------------------------------------------------------------
\subsubsection{Características técnicas}
%-------------------------------------------------------------------
\label{cap2:subsec:caracteristicas}

Dado su elevado rendimiento, alto nivel de integración y bajo consumo, el ADS1198 permite el desarrollo de instrumentación médica de prestaciones elevadas, tamaño reducido y bajo coste. Entre las características técnicas más destacables, podemos encontrar las siguientes:

\begin{itemize}
  \item 8 canales de alta resolución.
  \item Bajo consumo: 0.55mW/canal.
  \item Frecuencia de muestreo: desde 125Hz hasta 8KHz.
  \item Ganancia programable.
  \item Alimentación Unipolar o Bipolar.
  \item Oscilador y referencia internos.
  \item Señales de test integradas.
  \item Comunicación mediante interfaz SPI.
  \item Rango de temperatura operativo: 0 ºC a 70 ºC.
\end{itemize}

%-------------------------------------------------------------------
\subsection{Analizador lógico Saleae}
%-------------------------------------------------------------------
\label{cap2:subsec:saleae}

Se ha utilizado un analizador lógico, en este caso Saleae, con motivos de depuración durante el desarrollo del proyecto. Gracias al uso de este dispositivo ha sido posible detectar fallos muy concretos en periódos de tiempo relativamente pequeños, ya que de otra forma, en caso de no haberlo utilizado hubiese sido muy complicado el desarrollo, o al menos, hubiese llevado muchisimo más tiempo del esperado. 

La idea de funcionamiento de este dispositivo es muy sencilla. Cuenta con 8 canales que actuan como analizadores lógicos, por lo que basta con conectar cada analizador al canal que se desee analizar. 

Una vez conectado cada canal, entra en juego el software que proporciona el propio Saleae, que en este caso es multiplataforma \footnote{software disponible en \href{https://www.saleae.com/downloads}{https://www.saleae.com/downloads}}. Tras descargarlo e instalarlo bastará con conectar el analizador lógico por usb y configurarlo para comenzar a analizar cada una de las señales.

Entre sus principales características, cabe destacar als siguientes:

\begin{itemize}
  \item Flexible, software fácil de usar.
  \item Grandes buffers de muestras.
  \item Muy portable, conexión USB disponible.
  \item Analiza 24 protocolos distintos de comunicación.
  \item Decodificación de protocolos personalizada.
  \item Formatos de exportación de datos: CSV, Binario, VCD y Matlab.
  \item Marcadores de medidas, señaladores y temporizadores.
\end{itemize}

\figura{Vectorial/saleae}{width=1\textwidth}{fig:saleae}
{Software multiplataforma proporcionado por Saleae}

%\medskip

%Y también ponemos el acrónimo \ac{CVS} para que no cruja.


%-------------------------------------------------------------------
%\section*{\NotasBibliograficas}
%-------------------------------------------------------------------
%\TocNotasBibliograficas

%Citamos algo para que aparezca en la bibliografía\ldots
%\citep{ldesc2e}

%\medskip

%Y también ponemos el acrónimo \ac{CVS} para que no cruja.

%Ten en cuenta que si no quieres acrónimos (o no quieres que te falle la compilación en ``release'' mientras no tengas ninguno) basta con que no definas la constante \verb+\acronimosEnRelease+ (en \texttt{config.tex}).


%-------------------------------------------------------------------
%\section*{\ProximoCapitulo}
%-------------------------------------------------------------------
%\TocProximoCapitulo

%...

% Variable local para emacs, para  que encuentre el fichero maestro de
% compilación y funcionen mejor algunas teclas rápidas de AucTeX
%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../Tesis.tex"
%%% End:
